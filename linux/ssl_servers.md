# Установка SSL сертификатов на различные серверы

## **Задача:**

Все началось с настройки сервера Битрикс по запросу подрядчиков.
Естественно, как обычно, никто про сертификаты ничего не сказал, и вспомнили про них только когда начали интегрировать Битрикс и ВАТС от МТС.
Сначала настраивали сервер Битрикс на работу через Reverse Proxy настроенном на сервере NGINX.
До момента настройки NTLM-авторизации (про это есстественно тоже забыли упомянуть) все работало штатно.
Резюмируя условия задачи:

* Нужно добиться работы NTLM-авторизации в домене
* сервер должен быть доступен из мира
* Интерграция с ВАТС должна быть настроена.

Под эту задачу был заказан WildCard SSL сертификат и было принято решение перевести все серверы в нашей сети на этот сертификат.<br><br>

## **Как решали задачу:**

Сначала опишу настройку сервера Битрикс. Наш сервер был настроен с виртуальной машины от Битрикс в облаке.
Специально описываю настройку руками, чтобы так сказать прочувствовать весь спектр ощущений без автоматизации)).

На момент настройки прозрачную авторизацию на портале Битрикс уже включили и ничего не работает...

Первым делом вывели одно из доменных имен сервера Битрикс из Reverse Proxy.
Затем настроили внутрений доменный сервер DNS и авторизация через NTLM заработала.
Но внутри корпоративной сети... из мира ничего естественно не заработало.
<br><br>

### **Настройка SSL на сервере Битрикс**

Дальше настроили SSL-сертификат на веб-сервере Битрикс.
Порядок выполнения работ:

1. Готовим файл сертификатов  сервер Битрикс
   От центра сертификации мы получили четыре файла
    * yuor_domain_ru_2022_xx_xx.crt
    * intermediate_pem_rucenter_platinum_wildcard_1.crt
    * intermediate_pem_rucenter_platinum_wildcard_2.crt
    * root_pem_rucenter_platinum_wildcard_1.crt

   <br> И был получен файл privatekey.txt (сгенерирован при заказе выпуска сертификата).

``` bash
cat yuor_domain_ru_*.crt intermediate_*_1.crt intermediate_*_2.crt root_*.crt > cert-bundle.crt

cp privatekey.txt cert-bundle.key
```

2. Полученные файлы переносим на сервер и записываем в папку **/etc/ssl/yuor_domain/**

3. Правим конфиг для SSL **/etc/nginx/bx/site_enable/ssl.s1.conf**
   меняем путь к сертификату по умолчанию на свой и добавляем:

``` js
server {
    listen 80 default_server;
...
    if ($scheme != "https") {
        return 301 https://$host$request_uri;
    }
...
}
```

4. Удаляем ссылку на конфиг для http

```bash
sudo rm -f /etc/nginx/bx/site_enable/s1.conf
```

5. Проверяем конфиг на ошибки

```bash
nginx -T (или -t если подробный вывод не нужен)
```

6. Рестартим службу nginx

```bash
systemctl restart nginx.service
```

<br>Дальше были танцы в NGINX на proxy-сервере, чтобы добиться работы NTLM-авторизации, но не заработал проброс трафика через upstream.
В общем настроили проброс трафика со шлюза прямо на сервер Битрикс минуя обратный прокси-сервер.
Пришлось наступить жабе на горло и выделить один белый IP для сервера Битрикс. Возможно к этому вопросу мы еще вернемся, но пока отложен на неопределенный срок.<br><br>

### **Настройка SSL на сетевом хранилище NAS Synology**

Настраивается несложно через веб-интерфейс. Для установки предварительная подготовка файлов не требуется. Порядок установки такой:

1. открываем панель управления и все описанные ниже действия выполняем в ней
2. Открываем Безопасность -> Сертфикат
3. Нажимаем на кнопку Добавить -> Добавить новый -> Далее
4. Импортировать сертификат -> Далее
5. Выбираем скачанные ранее файлы из кабинета RU-Center
    * Секретный ключ -> Выбор (это файл с ключом для сертификата сгенерен в процессе запроса на выпуск сертификата)
    * Сертификат -> Выбор (это файл с сертификатом)
    * Промежуточный сертификат -> Выбор (сработал второй для RU-Center, первый никак не захотел)
    <br> -> Нажимаем Ок
6. Открываем Безопасность -> Сертфикат
7. Нажимаем на кнопку Настройки -> Выбираем для всех служб добавленный сертификат -> Нажимаем Ок
8. Открываем Портал для входа -> DSM
9. Устанавливаем галку на "Автоматически перенаправлять подключение HTTP на HTTPS для настольного ПК DSM"
10. Добавляем наш домен в поле Пользовательский домен

В процессе добавления настроек веб-сервер будет несколько раз перезапущен.
Соответственно после перезапуска будет выполнен вход заново.
Все. После выполненных выше действий, сертификат полностью работоспособен и активен.<br><br>

### **Настройка SSL на сервере ZABBIX**

Настрйока не сложная. Порядок настройки:

1. Полученные файлы от центра сертификации подготавливаем к использованию на NGINX (процесс такой же как для Битрикс).

2. Полученный файл + файл с ключом (расшифровывать не обязательно) копируем на сервер

    Правим конфиги. Нужно подправить только один конфиг /etc/zabbix/nginx.conf
    Добавляем в него:

``` js
server {
    listen 80;
    listen 443 ssl;
    server_name yuor_domain.com;

    charset utf-8;

    ssl_certificate /etc/zabbix/ssl/yuor_domain/yuor_domain.crt;
    ssl_certificate_key /etc/zabbix/ssl/yuor_domain/yuor_domain.key;

    if ($scheme != "https") {
        return 301 https://$host$request_uri;
    }
    ...
}
```

Остальное оставляем без изменений.

Проверяем конфиг на наличие ошибок:

```bash
nginx -T
# или 
# nginx -t если подробный вывод не нужен
```

Рестартим службы

```bash
sudo systemctl restart zabbix-server zabbix-agent nginx php7.4-fpm.service
```

<br><br>

### **Настройка SSL на сервере NGINX Reverse Proxy**

Полученные файлы от центра сертификации подготавливаем к использованию на NGINX.

Полученный файл + файл с ключом (расшифровывать не обязательно) копируем на сервер

Правим все конфиги для всех проксируемых серверов

``` js
server {
    listen 80;
    listen 443 default ssl;
    server_name yuor_domain.com;

    if ($scheme != "https") {
        return 301 https://$host$request_uri;
    }

    ssl_certificate /etc/ssl/yuor_domain/yuor_domain.crt;
    ssl_certificate_key /etc/ssl/yuor_domain/yuor_domain.key;

    ssl_session_timeout  10m;

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';
    ssl_prefer_server_ciphers on;
...
}
```

Проверяем конфиг NGINX на наличие ошибок

```bash
nginx -T
# или 
# nginx -t если подробный вывод не нужен
```

Рестартим службу NGINX

```bash
sudo systemctl restart nginx.service
```

<br><br>

### **Настройка SSL на сервере Confluence**

Так как сервер доступен через обратный прокси из мира, то находим мануал на портале Atlassian для нашего случая.

Конфигурирование сервера описано в мануале на портале atlassian.com

https://confluence.atlassian.com/doc/running-confluence-behind-nginx-with-ssl-858772080.html

Порядок выполнения:

1. Предварительно подготовленные и скопированные на сервер файлы должны быть на сервере Confluence

2. Вносим изменнения в конфиг сервера Confluence на NGINX Reverse Proxy
   (настройки стандартные и от остальных серверов ничем не отличаются)

3. Вносим изменения в файл **/opt/atlassian/confluence/conf/server.xml** 
   и изменяем коннектор для Tomcat
   * Нужно закомментировать строки коннектора по умолчанию <br>
   (секция "DEFAULT - Direct connction with no proxy...")
   * И раскомментировать строки коннектора HTTPS <br>
   (секция "HTTPS - Proxying Confluence via Apache or Nginx over HTTPS")

4. Рестартим службу Confluence

<br><br>

Вот в кратком описании и все действия по настройке SSL для веб-серверов. Возможно данная информация будет пололнена в дальнейшем.

## Навигация
[Вернуться в основное меню](../README.md)
<br> [Linux](../linux/README.md)
